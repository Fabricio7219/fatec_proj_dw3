<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Aluno - FatecWeek 2025</title>
    <link rel="stylesheet" href="style-dashboard.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <img src="https://i.imgur.com/WXNFN93.png" alt="Logo FatecWeek" class="logo-principal">
            <div class="user-header">
                <span class="user-name" id="userHeaderName">üéì RA: <span id="userRA">---</span> - <span id="userNome">---</span></span>
                <a href="#" class="btn-sair" onclick="logoutUsuario(event)">Sair</a>
            </div>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="dashboard-layout">
            <!-- Sidebar de Not√≠cias -->
            <aside class="noticias-sidebar">
                <h3>üì∞ Avisos</h3>
                
                <a href="https://www.vestibularfatec.com.br/" target="_blank" class="noticia-mini">
                    <div class="noticia-icone vestibulinho">üéì</div>
                    <div>
                        <strong>Vestibulinho</strong>
                        <p>Inscri√ß√µes abertas</p>
                    </div>
                </a>

                <a href="https://forms.gle/exemplo" target="_blank" class="noticia-mini">
                    <div class="noticia-icone questionario">üìù</div>
                    <div>
                        <strong>Question√°rio</strong>
                        <p>Avalie seu curso</p>
                    </div>
                </a>

                <a href="https://www.cps.sp.gov.br/" target="_blank" class="noticia-mini">
                    <div class="noticia-icone portal">üåê</div>
                    <div>
                        <strong>Portal CPS</strong>
                        <p>Notas e frequ√™ncia</p>
                    </div>
                </a>

                <a href="https://www.fatec.sp.gov.br/" target="_blank" class="noticia-mini">
                    <div class="noticia-icone biblioteca">üìö</div>
                    <div>
                        <strong>Biblioteca</strong>
                        <p>Acervo digital</p>
                    </div>
                </a>

                <a href="https://forms.gle/exemplo2" target="_blank" class="noticia-mini">
                    <div class="noticia-icone estagios">üíº</div>
                    <div>
                        <strong>Est√°gios</strong>
                        <p>Vagas dispon√≠veis</p>
                    </div>
                </a>
            </aside>

            <!-- Conte√∫do Principal -->
            <div class="dashboard-content">
                <div class="dashboard-header dashboard-header-aluno">
                    <h1>Bem-vindo ao FatecWeek 2025!</h1>
                    <p>Escolha as palestras que deseja participar</p>
                </div>

                <!-- Estat√≠sticas do Aluno -->
                <div class="stats-grid">
                    <div class="stat-card card">
                        <div class="stat-icon">üìö</div>
                        <div class="stat-info">
                            <h3 id="totalInscritas">0</h3>
                            <p>Palestras Inscritas</p>
                        </div>
                    </div>
                    
                    <div class="stat-card card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <h3 id="totalComparecidas">0</h3>
                            <p>Comparecidas</p>
                        </div>
                    </div>
                    
                    <div class="stat-card card">
                        <div class="stat-icon">‚è∞</div>
                        <div class="stat-info">
                            <h3 id="horasCertificado">0h</h3>
                            <p>Horas de Certificado</p>
                        </div>
                    </div>
                    
                    <div class="stat-card card">
                        <div class="stat-icon">ÔøΩ</div>
                        <div class="stat-info">
                            <h3 id="pontosTotal">0</h3>
                            <p>Pontos</p>
                        </div>
                    </div>
                    
                    <div class="stat-card card">
                        <div class="stat-icon">ÔøΩüéØ</div>
                        <div class="stat-info">
                            <h3 id="progressoCertificado">0%</h3>
                            <p>Progresso</p>
                        </div>
                    </div>
                </div>

                <!-- Palestras Dispon√≠veis -->
                <div class="palestras-disponiveis card">
                    <h2>üìö Palestras Dispon√≠veis</h2>
                    <p class="subtitulo">Clique em "Inscrever-se" para participar das palestras</p>

                    <div class="palestras-lista" id="palestrasLista">
                        <p>Carregando palestras...</p>
                    </div>
                </div>

                <!-- Minhas Inscri√ß√µes -->
                <div class="minhas-inscricoes card" id="minhasInscricoes" style="display: none;">
                    <h2>‚úÖ Minhas Inscri√ß√µes</h2>
                    <div id="listaInscricoes"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Popup de Boas-Vindas com Not√≠cias -->
    <div id="popupNoticias" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close" onclick="fecharPopup()">√ó</button>
            
            <div class="popup-header">
                <h2>üéâ Bem-vindo ao FatecWeek 2025!</h2>
                <p>Confira as novidades e avisos importantes</p>
            </div>

            <div class="popup-body">
                <div class="popup-avisos">
                    <div class="popup-aviso urgente">
                        <span class="aviso-badge">üî¥ Urgente</span>
                        <h3>Vestibulinho FATEC 2025</h3>
                        <p>Inscri√ß√µes abertas at√© 15/11. N√£o perca o prazo!</p>
                        <a href="https://www.vestibularfatec.com.br/" target="_blank">Inscrever-se ‚Üí</a>
                    </div>

                    <div class="popup-aviso importante">
                        <span class="aviso-badge">üü° Importante</span>
                        <h3>Question√°rio do Curso</h3>
                        <p>Avalie seu curso e ajude a melhorar a qualidade do ensino.</p>
                        <a href="https://forms.gle/exemplo" target="_blank">Preencher agora ‚Üí</a>
                    </div>

                    <div class="popup-aviso info">
                        <span class="aviso-badge">üîµ Info</span>
                        <h3>Portal do Aluno Atualizado</h3>
                        <p>Acesse suas notas e frequ√™ncia no novo portal CPS.</p>
                        <a href="https://www.cps.sp.gov.br/" target="_blank">Acessar portal ‚Üí</a>
                    </div>

                    <div class="popup-aviso info">
                        <span class="aviso-badge">üíº Vagas</span>
                        <h3>Programa de Est√°gios</h3>
                        <p>Novas vagas dispon√≠veis para alunos da FATEC.</p>
                        <a href="https://forms.gle/exemplo2" target="_blank">Ver vagas ‚Üí</a>
                    </div>
                </div>
            </div>

            <div class="popup-footer">
                <label class="checkbox-nao-mostrar">
                    <input type="checkbox" id="naoMostrarNovamente" onchange="salvarPreferencia()">
                    N√£o mostrar novamente hoje
                </label>
                <button class="btn-fechar-popup" onclick="fecharPopup()">Entendi</button>
            </div>
        </div>
    </div>

    <!-- Modal de Inscri√ß√£o -->
    <div id="modalInscricao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Formul√°rio de Inscri√ß√£o</h2>
                <span class="modal-close" onclick="fecharModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="palestra-selecionada">
                    <h3 id="palestraSelecionadaTitulo"></h3>
                    <p id="palestraSelecionadaInfo"></p>
                </div>

                <form id="formInscricao" onsubmit="confirmarInscricao(event)">
                    <!-- Dados do Google/Microsoft (preenchidos automaticamente) -->
                    <div class="form-section">
                        <h4>üìã Dados Pessoais (via Google)</h4>
                        <div class="form-group-readonly">
                            <label>Nome Completo:</label>
                            <input type="text" id="nomeCompleto" value="Nome do Aluno" readonly>
                        </div>
                        <div class="form-group-readonly">
                            <label>E-mail Institucional:</label>
                            <input type="email" id="emailInstitucional" value="aluno@fatec.sp.gov.br" readonly>
                        </div>
                    </div>

                    <!-- Dados adicionais -->
                    <div class="form-section">
                        <h4>‚úèÔ∏è Dados Adicionais</h4>
                        
                        <div class="form-group">
                            <label for="ra">RA (Registro Acad√™mico) *</label>
                            <input type="text" id="ra" name="ra" required 
                                   placeholder="Digite seu RA (somente n√∫meros)"
                                   pattern="[0-9]+" 
                                   maxlength="10"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            <small>Exemplo: 123456</small>
                        </div>

                        <div class="form-group">
                            <label for="fatec">FATEC *</label>
                            <select id="fatec" name="fatec" required>
                                <option value="">Selecione sua FATEC</option>
                                <option value="fatec-osasco">FATEC Osasco - Prefeito Hirant Sanazar</option>
                                <option value="fatec-sp">FATEC S√£o Paulo</option>
                                <option value="fatec-zona-leste">FATEC Zona Leste</option>
                                <option value="fatec-zona-sul">FATEC Zona Sul</option>
                                <option value="fatec-ipiranga">FATEC Ipiranga</option>
                                <option value="fatec-guarulhos">FATEC Guarulhos</option>
                                <option value="fatec-carapicuiba">FATEC Carapicu√≠ba</option>
                                <option value="fatec-tatuape">FATEC Tatuap√©</option>
                                <option value="fatec-santo-andre">FATEC Santo Andr√©</option>
                                <option value="fatec-maua">FATEC Mau√°</option>
                                <option value="fatec-sao-caetano">FATEC S√£o Caetano do Sul</option>
                                <option value="fatec-diadema">FATEC Diadema</option>
                                <option value="outra">Outra FATEC</option>
                            </select>
                        </div>

                        <div class="form-group" id="outraFatecGroup" style="display: none;">
                            <label for="outraFatec">Qual FATEC?</label>
                            <input type="text" id="outraFatec" name="outraFatec" placeholder="Digite o nome da sua FATEC">
                        </div>

                        <div class="form-group">
                            <label for="curso">Curso *</label>
                            <select id="curso" name="curso" required>
                                <option value="">Selecione seu curso</option>
                                <option value="ads">An√°lise e Desenvolvimento de Sistemas</option>
                                <option value="dsm">Desenvolvimento de Software Multiplataforma</option>
                                <option value="si">Sistemas para Internet</option>
                                <option value="bd">Banco de Dados</option>
                                <option value="jogos">Jogos Digitais</option>
                                <option value="redes">Redes de Computadores</option>
                                <option value="si-gestao">Sistemas de Informa√ß√£o - Gest√£o</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="periodo">Per√≠odo *</label>
                            <select id="periodo" name="periodo" required>
                                <option value="">Selecione o per√≠odo</option>
                                <option value="1">1¬∫ Semestre</option>
                                <option value="2">2¬∫ Semestre</option>
                                <option value="3">3¬∫ Semestre</option>
                                <option value="4">4¬∫ Semestre</option>
                                <option value="5">5¬∫ Semestre</option>
                                <option value="6">6¬∫ Semestre</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="telefone">Telefone/WhatsApp</label>
                            <input type="tel" id="telefone" name="telefone" 
                                   placeholder="(11) 98765-4321"
                                   oninput="formatarTelefone(this)">
                            <small>Opcional - Para contato em caso de altera√ß√µes</small>
                        </div>
                    </div>

                    <!-- Confirma√ß√£o -->
                    <div class="form-section">
                        <h4>‚úÖ Confirma√ß√£o</h4>
                        
                        <div class="form-group-checkbox">
                            <input type="checkbox" id="confirmacaoPalestra" required>
                            <label for="confirmacaoPalestra">
                                Confirmo que pretendo participar da palestra selecionada e estou ciente de que a presen√ßa ser√° registrada via QR Code
                            </label>
                        </div>

                        <div class="form-group-checkbox">
                            <input type="checkbox" id="termosUso" required>
                            <label for="termosUso">
                                Li e concordo com os termos de uso e pol√≠tica de privacidade do evento
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-cancelar-modal" onclick="fecharModal()">Cancelar</button>
                        <button type="submit" class="btn-confirmar-inscricao">‚úì Confirmar Inscri√ß√£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function logoutUsuario(event) {
            event.preventDefault();
            fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(() => {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            })
            .catch(() => {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            });
        }

    const palestrasInscritas = new Set();
        let horasPorPalestra = {};
        let palestrasNomes = {};
        let palestrasHorarios = {};
    let usuarioAtual = null;

        function formatDateTime(dateStr, duracaoMin) {
            try {
                const d = new Date(dateStr);
                const date = d.toLocaleDateString();
                const start = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const endDate = new Date(d.getTime() + (duracaoMin || 60) * 60000);
                const end = endDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return `${date} - ${start} √†s ${end}`;
            } catch (e) {
                return 'Data/hor√°rio a confirmar';
            }
        }

        // Carrega palestras do backend e renderiza a lista dinamicamente
        async function carregarPalestras() {
            const container = document.getElementById('palestrasLista');
            container.innerHTML = '<p>Carregando palestras...</p>';
            try {
                const resp = await fetch('/api/palestras');
                if (!resp.ok) throw new Error('Erro ao buscar palestras');
                const json = await resp.json();
                const list = json.dados || json;

                // Reset
                horasPorPalestra = {};
                palestrasNomes = {};
                palestrasHorarios = {};

                if (!Array.isArray(list) || list.length === 0) {
                    container.innerHTML = '<p>Nenhuma palestra dispon√≠vel no momento.</p>';
                    return;
                }

                container.innerHTML = '';

                list.forEach((p, index) => {
                    const id = String(p._id || p.id || (index+1));
                    palestrasNomes[id] = p.titulo || `Palestra ${index+1}`;
                    palestrasHorarios[id] = formatDateTime(p.data, p.duracao_minutos);
                    horasPorPalestra[id] = (p.duracao_minutos || 60) / 60;

                    const item = document.createElement('div');
                    item.className = 'palestra-item';

                    item.innerHTML = `
                        <div class="palestra-badge">üé§</div>
                        <div class="palestra-info-completa">
                            <h3>${p.titulo}</h3>
                            <div class="palestra-detalhes">
                                <span class="detalhe"><strong>üìÖ Data:</strong> ${new Date(p.data).toLocaleDateString()}</span>
                                <span class="detalhe"><strong>‚è∞ Hor√°rio:</strong> ${palestrasHorarios[id]}</span>
                                <span class="detalhe"><strong>üìç Local:</strong> ${p.local || 'N√£o informado'}</span>
                                <span class="detalhe"><strong>üë®‚Äçüè´ Palestrante:</strong> ${p.palestrante || 'A definir'}</span>
                                <span class="detalhe"><strong>üèÖ Pontos:</strong> ${typeof p.pontos === 'number' ? p.pontos : 0}</span>
                            </div>
                            <p class="palestra-descricao">${p.descricao || ''}</p>
                        </div>
                        <button class="btn-inscrever" onclick="abrirFormularioInscricao('${id}', this)">Inscrever-se</button>
                    `;

                    // Mostra um mini-resumo do aluno ao lado do bot√£o (se logado)
                    try {
                        if (usuarioAtual && (usuarioAtual.nome || usuarioAtual.ra || usuarioAtual.curso)) {
                            const mini = document.createElement('div');
                            mini.className = 'aluno-mini';
                            const cursoTxt = usuarioAtual.curso ? `, Curso: ${usuarioAtual.curso}` : '';
                            const raTxt = usuarioAtual.ra ? `RA: ${usuarioAtual.ra}` : '';
                            mini.style.fontSize = '0.85rem';
                            mini.style.color = '#666';
                            mini.style.marginTop = '6px';
                            mini.textContent = `${usuarioAtual.nome || ''} ${raTxt ? '‚Äî ' + raTxt : ''}${cursoTxt}`;
                            item.appendChild(mini);
                        }
                    } catch(e) {}

                    container.appendChild(item);
                });

            } catch (err) {
                console.error('Erro ao carregar palestras:', err);
                container.innerHTML = '<p>Erro ao carregar palestras. Tente novamente mais tarde.</p>';
            }
        }

        let palestraAtual = null;
        let botaoAtual = null;

        // Verificar e mostrar popup ao carregar a p√°gina
        window.onload = function() {
            verificarPopup();
        };

        function verificarPopup() {
            const hoje = new Date().toDateString();
            const ultimaVisualizacao = localStorage.getItem('popupNoticiasData');
            const naoMostrar = localStorage.getItem('popupNoticiasNaoMostrar');
            
            // Se nunca viu ou se passou 1 dia
            if (!ultimaVisualizacao || ultimaVisualizacao !== hoje || naoMostrar !== 'true') {
                setTimeout(() => {
                    document.getElementById('popupNoticias').style.display = 'flex';
                }, 500); // Atraso de 0.5s para melhor UX
            }
        }

        function fecharPopup() {
            document.getElementById('popupNoticias').style.display = 'none';
            const hoje = new Date().toDateString();
            localStorage.setItem('popupNoticiasData', hoje);
        }

        function salvarPreferencia() {
            const checkbox = document.getElementById('naoMostrarNovamente');
            if (checkbox.checked) {
                localStorage.setItem('popupNoticiasNaoMostrar', 'true');
            } else {
                localStorage.removeItem('popupNoticiasNaoMostrar');
            }
        }

        // Fechar popup ao clicar fora
        document.addEventListener('click', function(event) {
            const popup = document.getElementById('popupNoticias');
            if (event.target === popup) {
                fecharPopup();
            }
        });

        async function carregarUsuarioAtual(force=false){
            if (usuarioAtual && !force) return usuarioAtual;
            try{
                const res = await fetch('/api/auth/me', { credentials: 'include' });
                if (res.status === 401) throw new Error('unauthorized');
                usuarioAtual = await res.json();
                // Atualiza pontos no UI se dispon√≠vel
                try {
                    const pontos = (typeof usuarioAtual.pontos_total === 'number') ? usuarioAtual.pontos_total : 0;
                    const pontosEl = document.getElementById('pontosTotal');
                    if (pontosEl) pontosEl.textContent = String(pontos);
                } catch(e) {}
                return usuarioAtual;
            }catch(e){
                // redireciona para login Google e volta ao dashboard
                const back = encodeURIComponent('/dashboard-aluno.html');
                window.location.href = '/api/auth/google?returnTo=' + back;
                throw e;
            }
        }

        function mapCursoToOptionValue(cursoStr){
            if (!cursoStr) return '';
            const s = String(cursoStr).toLowerCase();
            if (s.includes('desenvolvimento de software') || s.includes('dsm')) return 'dsm';
            if (s.includes('an√°lise') || s.includes('analise') || s.includes('ads')) return 'ads';
            if (s.includes('sistemas para internet') || s === 'si' || s.includes('internet')) return 'si';
            if (s.includes('banco de dados') || s.includes('bd')) return 'bd';
            if (s.includes('jogo')) return 'jogos';
            if (s.includes('rede')) return 'redes';
            if (s.includes('gest')) return 'si-gestao';
            return 'outro';
        }

        // Abrir formul√°rio de inscri√ß√£o
        async function abrirFormularioInscricao(id, btn) {
            // Se j√° estiver inscrito, cancelar
            if (palestrasInscritas.has(id)) {
                if (confirm('Voc√™ j√° est√° inscrito nesta palestra. Deseja cancelar a inscri√ß√£o?')) {
                    cancelarInscricao(id);
                }
                return;
            }

            palestraAtual = id;
            botaoAtual = btn;

            // Preencher informa√ß√µes da palestra no modal
            document.getElementById('palestraSelecionadaTitulo').textContent = palestrasNomes[id];
            document.getElementById('palestraSelecionadaInfo').textContent = palestrasHorarios[id];

            // Carrega dados reais do aluno e preenche automaticamente
            try{
                await carregarUsuarioAtual();
                // Inscri√ß√£o direta sem formul√°rio: um clique e confirma
                await inscreverDireto(id, btn);
                return; // n√£o abre modal no fluxo direto

                // Abaixo: fallback ‚Äî manter modal (desativado por return acima)
                const nomeEl = document.getElementById('nomeCompleto');
                const emailEl = document.getElementById('emailInstitucional');
                const raEl = document.getElementById('ra');
                const fatecEl = document.getElementById('fatec');
                const cursoEl = document.getElementById('curso');
                const periodoEl = document.getElementById('periodo');

                // Nome e Email readonly
                nomeEl.value = usuarioAtual.nome || usuarioAtual.displayName || '';
                emailEl.value = usuarioAtual.email || '';
                nomeEl.readOnly = true;
                emailEl.readOnly = true;

                // RA
                if (usuarioAtual.ra) {
                    raEl.value = usuarioAtual.ra;
                    raEl.readOnly = true;
                } else {
                    raEl.value = '';
                    raEl.readOnly = false;
                }

                // Curso
                const v = mapCursoToOptionValue(usuarioAtual.curso);
                if (v) {
                    cursoEl.value = v;
                    cursoEl.disabled = true;
                } else {
                    cursoEl.disabled = false;
                }

                // Per√≠odo (semestre)
                if (usuarioAtual.semestre) {
                    periodoEl.value = String(usuarioAtual.semestre);
                    periodoEl.disabled = true;
                } else {
                    periodoEl.disabled = false;
                }

                // FATEC
                if (usuarioAtual.fatec) {
                    // tenta escolher uma op√ß√£o compat√≠vel, sen√£o deixa selecion√°vel
                    const opt = Array.from(fatecEl.options).find(o => usuarioAtual.fatec.toLowerCase().includes(o.text.toLowerCase()) || usuarioAtual.fatec.toLowerCase().includes(o.value.toLowerCase()));
                    if (opt) fatecEl.value = opt.value;
                    fatecEl.disabled = !!opt;
                } else {
                    // define uma sugest√£o padr√£o
                    fatecEl.value = fatecEl.value || 'fatec-osasco';
                    fatecEl.disabled = false;
                }

                // Campos adicionais n√£o devem travar a inscri√ß√£o
                raEl.required = false;
                cursoEl.required = false;
                periodoEl.required = false;
                fatecEl.required = false;
            } catch(e){
                // Em caso de erro, mant√©m formul√°rio aberto com m√≠nimos
            }

            // Abrir modal (fallback)
            document.getElementById('modalInscricao').style.display = 'flex';
        }

        // Fechar modal
        function fecharModal() {
            document.getElementById('modalInscricao').style.display = 'none';
            palestraAtual = null;
            botaoAtual = null;
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalInscricao');
            if (event.target === modal) {
                fecharModal();
            }
        }

        // Mostrar/ocultar campo "Outra FATEC"
        document.getElementById('fatec').addEventListener('change', function() {
            const outraFatecGroup = document.getElementById('outraFatecGroup');
            const outraFatecInput = document.getElementById('outraFatec');
            
            if (this.value === 'outra') {
                outraFatecGroup.style.display = 'block';
                outraFatecInput.required = true;
            } else {
                outraFatecGroup.style.display = 'none';
                outraFatecInput.required = false;
            }
        });

        // Formatar telefone
        function formatarTelefone(input) {
            let valor = input.value.replace(/\D/g, '');
            
            if (valor.length <= 10) {
                valor = valor.replace(/(\d{2})(\d)/, '($1) $2');
                valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
            } else {
                valor = valor.replace(/(\d{2})(\d)/, '($1) $2');
                valor = valor.replace(/(\d{5})(\d)/, '$1-$2');
            }
            
            input.value = valor;
        }

        // Mapa de inscri√ß√µes: palestraId -> inscricaoId
        const inscricoesMap = {};

        // Confirmar inscri√ß√£o ‚Äî envia ao backend e atualiza UI
        async function confirmarInscricao(event) {
            event.preventDefault();

            if (!palestraAtual) return;

            // Coletar dados m√≠nimos
            const payload = { palestraId: String(palestraAtual) };

            try {
                const resp = await fetch('/api/inscricoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    alert(err.erro || err.message || 'Erro ao criar inscri√ß√£o');
                    return;
                }

                const json = await resp.json();
                // API retorna { mensagem, inscricao }
                const inscricao = json.inscricao || json;
                const inscricaoId = inscricao._id || inscricao.id;

                // Marca localmente
                inscricoesMap[String(palestraAtual)] = inscricaoId;
                palestrasInscritas.add(palestraAtual);

                // Atualizar bot√£o
                if (botaoAtual) {
                    botaoAtual.textContent = '‚úì Inscrito';
                    botaoAtual.classList.add('inscrito');
                }

                // Atualizar interface
                atualizarEstatisticas();
                await carregarInscricoes();

                // Fechar modal
                fecharModal();

                alert('‚úÖ Inscri√ß√£o realizada com sucesso!\n\nVoc√™ receber√° uma confirma√ß√£o no e-mail cadastrado.');
            } catch (err) {
                console.error('Erro ao confirmar inscri√ß√£o:', err);
                alert('Erro de rede ao tentar inscrever. Tente novamente.');
            }
        }

        async function inscreverDireto(id, btn){
            const payload = { palestraId: String(id) };
            try {
                const resp = await fetch('/api/inscricoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    alert(err.erro || err.message || 'Erro ao criar inscri√ß√£o');
                    return;
                }
                const json = await resp.json();
                const inscricao = json.inscricao || json;
                const inscricaoId = inscricao._id || inscricao.id;
                const pid = String(id);
                inscricoesMap[pid] = inscricaoId;
                palestrasInscritas.add(id);
                if (btn) { btn.textContent = '‚úì Inscrito'; btn.classList.add('inscrito'); }
                atualizarEstatisticas();
                await carregarInscricoes();
                alert('‚úÖ Inscri√ß√£o realizada com sucesso!');
            } catch (err) {
                console.error('Erro ao inscrever diretamente:', err);
                alert('Erro de rede ao tentar inscrever. Tente novamente.');
            }
        }

        // Atualizar estat√≠sticas
        function atualizarEstatisticas() {
            const total = palestrasInscritas.size;
            document.getElementById('totalInscritas').textContent = total;
            document.getElementById('totalComparecidas').textContent = '0';
            
            let horasTotal = 0;
            palestrasInscritas.forEach(id => {
                horasTotal += horasPorPalestra[id];
            });
            
            document.getElementById('horasCertificado').textContent = horasTotal.toFixed(1) + 'h';
            
            const progresso = Math.min((horasTotal / 20) * 100, 100);
            document.getElementById('progressoCertificado').textContent = progresso.toFixed(0) + '%';
        }

        // Atualizar minhas inscri√ß√µes
        function atualizarMinhasInscricoes() {
            const container = document.getElementById('minhasInscricoes');
            const lista = document.getElementById('listaInscricoes');
            
            if (palestrasInscritas.size === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            lista.innerHTML = '';
            palestrasInscritas.forEach(id => {
                const div = document.createElement('div');
                div.className = 'inscricao-item';
                div.innerHTML = `
                    <div class="inscricao-info">
                        <h4>${palestrasNomes[id]}</h4>
                        <p>üìÖ ${palestrasHorarios[id]} - ‚è±Ô∏è ${horasPorPalestra[id]}h</p>
                    </div>
                    <button class="btn-cancelar" onclick="cancelarInscricao(${id})">Cancelar</button>
                `;
                lista.appendChild(div);
            });
        }

        // Cancelar inscri√ß√£o (persiste no backend quando poss√≠vel)
        async function cancelarInscricao(id) {
            if (!confirm('Deseja realmente cancelar esta inscri√ß√£o?')) return;

            try {
                const pid = String(id);
                const inscricaoId = inscricoesMap[pid];

                if (inscricaoId) {
                    const resp = await fetch(`/api/inscricoes/${inscricaoId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        alert(err.erro || 'Erro ao cancelar inscri√ß√£o');
                        return;
                    }

                    // Remover do mapa
                    delete inscricoesMap[pid];
                } else {
                    // fallback: apenas limpa localmente
                    console.warn('Cancelando inscri√ß√£o localmente (sem inscri√ß√£o registrada no backend)');
                }

                palestrasInscritas.delete(id);

                // Atualizar bot√£o na lista de palestras ‚Äî tenta encontrar pelo atributo onclick
                const botoes = document.querySelectorAll('.btn-inscrever');
                botoes.forEach(btn => {
                    const onclick = btn.getAttribute('onclick') || '';
                    const m = onclick.match(/abrirFormularioInscricao\(\s*['"]?([^'"\),]+)['"]?\s*,/);
                    if (m && m[1] == id) {
                        btn.textContent = 'Inscrever-se';
                        btn.classList.remove('inscrito');
                    }
                });

                await carregarInscricoes();
                atualizarEstatisticas();
                atualizarMinhasInscricoes();

                alert('‚ùå Inscri√ß√£o cancelada com sucesso!');
            } catch (err) {
                console.error('Erro ao cancelar inscri√ß√£o:', err);
                alert('Erro ao cancelar inscri√ß√£o. Tente novamente.');
            }
        }

        // Buscar dados do usu√°rio logado
        function preencherHeaderUsuario() {
            fetch('/api/auth/me', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    usuarioAtual = data;
                    if (data && data.nome) {
                        document.getElementById('userNome').textContent = data.nome;
                        document.getElementById('userRA').textContent = data.ra || '---';
                        try {
                            const pontos = (typeof data.pontos_total === 'number') ? data.pontos_total : 0;
                            const pontosEl = document.getElementById('pontosTotal');
                            if (pontosEl) pontosEl.textContent = String(pontos);
                        } catch(e) {}
                    }
                })
                .catch(() => {
                    document.getElementById('userNome').textContent = 'Usu√°rio';
                    document.getElementById('userRA').textContent = '---';
                });
        }

        // Carrega inscri√ß√µes do backend, atualiza mapa e UI
        async function carregarInscricoes() {
            try {
                const resp = await fetch('/api/inscricoes', { credentials: 'include' });
                if (!resp.ok) return;
                const json = await resp.json();
                const lista = json.dados || json;

                // Reset local
                palestrasInscritas.clear();
                for (const k in inscricoesMap) delete inscricoesMap[k];

                lista.forEach(ins => {
                    const pid = String(ins.palestraId);
                    inscricoesMap[pid] = ins._id || ins.id;
                    palestrasInscritas.add(pid);
                });

                // Atualiza bot√µes
                const botoes = document.querySelectorAll('.btn-inscrever');
                botoes.forEach(btn => {
                    const onclick = btn.getAttribute('onclick') || '';
                    const m = onclick.match(/abrirFormularioInscricao\(\s*['"]?([^'"\),]+)['"]?\s*,/);
                    if (m) {
                        const pid = m[1];
                        if (inscricoesMap[pid]) {
                            btn.textContent = '‚úì Inscrito';
                            btn.classList.add('inscrito');
                        } else {
                            btn.textContent = 'Inscrever-se';
                            btn.classList.remove('inscrito');
                        }
                    }
                });

                atualizarEstatisticas();
                atualizarMinhasInscricoes();
            } catch (err) {
                console.error('Erro ao carregar inscri√ß√µes:', err);
            }
        }

    // Inicializa header, carrega palestras e inscri√ß√µes (em ordem)
    preencherHeaderUsuario();
    carregarPalestras().then(() => carregarInscricoes());
    </script>
</body>
</html>