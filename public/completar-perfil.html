<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Completar Perfil - FatecWeek</title>
  <link rel="stylesheet" href="style-completar.css">
</head>

<body>
  <div class="form-container">
    <h1>ðŸ‘¤ Completar Perfil</h1>
    <p>OlÃ¡! Antes de continuar, precisamos de algumas informaÃ§Ãµes.</p>

    <form id="formPerfil">
      <!-- Campos ocultos preenchidos pelo login -->
      <input type="hidden" id="email" name="email">
      <input type="hidden" id="nome" name="nome">

      <!-- Escolha do tipo (Aluno ou Docente) -->
      <div class="form-group">
        <label>Tipo</label>
        <div>
          <label><input type="radio" name="tipo" value="aluno" id="tipoAluno"> Aluno</label>
          <label><input type="radio" name="tipo" value="docente" id="tipoDocente"> Docente</label>
        </div>
      </div>

      <!-- Campos do aluno (RA e semestre) -->
      <div id="camposAluno" style="display:none;">
        <div class="form-group">
          <label for="ra">RA</label>
          <input type="text" id="ra" name="ra" placeholder="Ex: 2321101234">
        </div>

        <div class="form-group">
          <label for="semestre">Semestre</label>
          <select id="semestre" name="semestre">
            <option value="1Âº Semestre">1Âº Semestre</option>
            <option value="2Âº Semestre">2Âº Semestre</option>
            <option value="3Âº Semestre">3Âº Semestre</option>
            <option value="4Âº Semestre">4Âº Semestre</option>
            <option value="5Âº Semestre">5Âº Semestre</option>
            <option value="6Âº Semestre">6Âº Semestre</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="fatec">Fatec de Origem</label>
        <select id="fatec" name="fatec">
          <option value="Fatec Osasco">Fatec Osasco</option>
          <option value="Fatec SÃ£o Paulo">Fatec SÃ£o Paulo</option>
          <option value="Fatec Barueri">Fatec Barueri</option>
          <option value="Fatec CarapicuÃ­ba">Fatec CarapicuÃ­ba</option>
          <option value="Fatec Cotia">Fatec Cotia</option>
          <option value="Fatec Zona Leste">Fatec Zona Leste</option>
          <option value="Fatec Itaquera">Fatec Itaquera</option>
          <option value="Outra">Outra</option>
        </select>
      </div>

      <div class="form-group">
        <label for="curso">Curso</label>
        <select id="curso" name="curso">
          <option value="AutomaÃ§Ã£o Industrial">AutomaÃ§Ã£o Industrial</option>
          <option value="Desenvolvimento de Software Multiplataforma">Desenvolvimento de Software Multiplataforma</option>
          <option value="GestÃ£o Empresarial (EaD)">GestÃ£o Empresarial (EaD)</option>
          <option value="GestÃ£o Financeira">GestÃ£o Financeira</option>
          <option value="ManutenÃ§Ã£o Industrial">ManutenÃ§Ã£o Industrial</option>
          <option value="Redes de Computadores">Redes de Computadores</option>
          <option value="Sistemas BiomÃ©dicos">Sistemas BiomÃ©dicos</option>
        </select>
      </div>

      <button type="submit" class="btn">Salvar e Continuar</button>
    </form>
  </div>

  <script>
    const form = document.getElementById('formPerfil');
    const camposAluno = document.getElementById('camposAluno');
    const tipoAluno = document.getElementById('tipoAluno');
    const tipoDocente = document.getElementById('tipoDocente');

    // Mostra/oculta campos de aluno
    function updateCampos() {
      const tipo = document.querySelector('input[name="tipo"]:checked');
      if (tipo && tipo.value === 'aluno') {
        camposAluno.style.display = 'block';
      } else {
        camposAluno.style.display = 'none';
      }
    }

    tipoAluno.addEventListener('change', updateCampos);
    tipoDocente.addEventListener('change', updateCampos);

    window.addEventListener('load', async () => {
      // Tenta obter dados do login
      try {
        const res = await fetch('/api/auth/me', { credentials: 'include' });
        if (res.status === 200) {
          const user = await res.json();
          // Se jÃ¡ estÃ¡ cadastrado, redireciona
          if (user.cadastroCompleto) {
            if (user.tipo === 'admin') {
              window.location.href = '/admin.html';
              return;
            }
            window.location.href = user.tipo === 'docente' ? '/dashboard-docente.html' : '/dashboard-aluno.html';
            return;
          }

              // Preenche email/nome
              const emailField = document.getElementById('email');
              const nomeField = document.getElementById('nome');
              emailField.value = user.email || localStorage.getItem('email') || '';
              nomeField.value = user.nome || user.displayName || localStorage.getItem('nome') || '';

              // Se o servidor jÃ¡ sabe o tipo, prÃ©-seleciona; caso contrÃ¡rio, seleciona Aluno por padrÃ£o
              try {
                if (user.tipo === 'admin') {
                  // Admin nÃ£o precisa completar perfil
                  window.location.href = '/admin.html';
                  return;
                } else if (user.tipo === 'docente') {
                  document.getElementById('tipoDocente').checked = true;
                } else if (user.tipo === 'aluno') {
                  document.getElementById('tipoAluno').checked = true;
                } else {
                  // Default para evitar erros de 'campo obrigatÃ³rio'
                  document.getElementById('tipoAluno').checked = true;
                }
                updateCampos();
              } catch (e) {
                console.warn('NÃ£o foi possÃ­vel prÃ©-selecionar tipo:', e);
              }
        } else {
        // Sem sessÃ£o, tenta preencher a partir do localStorage e marca Aluno por padrÃ£o
          document.getElementById('email').value = localStorage.getItem('email') || '';
          document.getElementById('nome').value = localStorage.getItem('nome') || '';
          try { document.getElementById('tipoAluno').checked = true; updateCampos(); } catch(e){}
        }
      } catch (err) {
        console.error('Erro ao carregar dados do usuÃ¡rio:', err);
  document.getElementById('email').value = localStorage.getItem('email') || '';
  document.getElementById('nome').value = localStorage.getItem('nome') || '';
  try { document.getElementById('tipoAluno').checked = true; updateCampos(); } catch(e){}
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const tipo = formData.get('tipo');

      if (!tipo) {
        alert('Escolha se vocÃª Ã© Aluno ou Docente');
        return;
      }

      // Garante que email/nome estÃ£o preenchidos: se nÃ£o houver, busca /api/auth/me
      let emailVal = formData.get('email');
      let nomeVal = formData.get('nome');
      if ((!emailVal || !nomeVal)) {
        try {
          const me = await fetch('/api/auth/me', { credentials: 'include' });
          if (me.ok) {
            const u = await me.json();
            emailVal = emailVal || u.email || '';
            nomeVal = nomeVal || u.nome || u.displayName || '';
          }
        } catch (err) {
          console.warn('NÃ£o foi possÃ­vel obter /api/auth/me antes do submit:', err);
        }
      }

      const payload = {
        email: emailVal,
        nome: nomeVal,
        tipo,
        fatec: formData.get('fatec') || undefined,
        curso: formData.get('curso') || undefined
      };

      if (tipo === 'aluno') {
        payload.ra = formData.get('ra');
        payload.semestre = formData.get('semestre');
        if (!payload.ra || !payload.semestre) {
          alert('RA e semestre sÃ£o obrigatÃ³rios para alunos');
          return;
        }
      }
      // Para docente, nÃ£o exigir RA/semestre/curso; backend jÃ¡ trata defaults

      try {
        const resp = await fetch('/api/auth/completar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        const data = await resp.json();
        if (!resp.ok) {
          alert(data.erro || data.mensagem || 'Erro ao salvar perfil');
          return;
        }

        alert(data.mensagem || 'Perfil salvo com sucesso');
        window.location.href = tipo === 'docente' ? '/dashboard-docente.html' : '/dashboard-aluno.html';
      } catch (err) {
        console.error('Erro ao salvar perfil:', err);
        alert('Erro ao salvar perfil. Tente novamente.');
      }
    });
  </script>
</body>

</html>