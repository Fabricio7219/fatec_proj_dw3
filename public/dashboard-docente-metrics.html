<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard Docente - Métricas</title>
  <link rel="stylesheet" href="style-dashboard.css">
</head>
<body>
  <header class="header">
    <div class="header-content">
      <img src="https://i.imgur.com/WXNFN93.png" alt="Logo" class="logo-principal">
      <div class="user-header">
        <span id="userNome" class="user-name">Docente</span>
        <a href="#" class="btn-sair" onclick="logoutUsuario(event)">Sair</a>
      </div>
    </div>
  </header>

  <main class="dashboard-container">
    <h1>Métricas - Docente</h1>

    <section>
      <h2>Resumo</h2>
      <div id="resumo">Carregando métricas...</div>
    </section>

    <section>
      <h2>Palestras e inscrições</h2>
      <div id="listaPalestras">Carregando...</div>
    </section>
  </main>

  <script>
    function logoutUsuario(event) {
      event.preventDefault();
      fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
        .finally(() => window.location.href = 'index.html');
    }

    async function carregarMetrics() {
      try {
        const [pRes, iRes, meRes] = await Promise.all([
          fetch('/api/palestras'),
          fetch('/api/inscricoes'),
          fetch('/api/auth/me', { credentials: 'include' })
        ]);

        const palestrasJson = await pRes.json();
        const inscricoesJson = await iRes.json();
        const meJson = await meRes.json();

        const palestras = Array.isArray(palestrasJson.dados) ? palestrasJson.dados : (palestrasJson || []);
        const inscricoes = Array.isArray(inscricoesJson) ? inscricoesJson : (inscricoesJson.dados || []);

        const totalPalestras = palestras.length;
        const totalInscricoes = inscricoes.length;

        document.getElementById('resumo').innerHTML = `
          <p>Total de palestras: <strong>${totalPalestras}</strong></p>
          <p>Total de inscrições: <strong>${totalInscricoes}</strong></p>
          <p>Usuário: <strong>${meJson.nome || meJson.email || '—'}</strong></p>
        `;

        // Map counts per palestra
        const counts = {};
        inscricoes.forEach(ins => {
          const pid = ins.palestraId || ins.palestra || ins.palestra_id;
          if (!pid) return;
          counts[pid] = (counts[pid] || 0) + 1;
        });

        const listaDiv = document.getElementById('listaPalestras');
        listaDiv.innerHTML = '';

        if (palestras.length === 0) {
          listaDiv.innerText = 'Nenhuma palestra encontrada.';
          return;
        }

        palestras.forEach(p => {
          const item = document.createElement('div');
          item.className = 'palestra-item';
          const pid = p._id || p.id;
          item.innerHTML = `
            <h3>${p.titulo || '—'}</h3>
            <p>${p.resumo || p.descricao || ''}</p>
            <p><strong>Inscritos:</strong> ${counts[pid] || 0}</p>
          `;
          listaDiv.appendChild(item);
        });

      } catch (err) {
        document.getElementById('resumo').innerText = 'Erro ao carregar métricas';
        document.getElementById('listaPalestras').innerText = 'Erro ao carregar palestras';
      }
    }

    carregarMetrics();
  </script>
</body>
</html>