<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Docente - FatecWeek 2025</title>
    <link rel="stylesheet" href="style-dashboard.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <img src="https://i.imgur.com/WXNFN93.png" alt="Logo FatecWeek" class="logo-principal">
            <div class="user-header">
                <span class="user-name" id="userHeaderName">üë®‚Äçüè´ Nome: <span id="userNome">---</span></span>
                <a href="#" class="btn-sair" onclick="logoutUsuario(event)">Sair</a>
            </div>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="dashboard-header">
            <h1>Painel de Controle - Docente</h1>
            <p>Gerencie as presen√ßas das palestras</p>
        </div>

        <!-- Seletor de Palestras (din√¢mico) -->
        <div class="palestras-selector card">
            <h2>üìö Selecione a Palestra</h2>
            <div class="palestras-grid" id="palestrasGrid">
                <!-- Bot√µes ser√£o renderizados dinamicamente -->
            </div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card card">
                <div class="stat-icon">üë•</div>
                <div class="stat-info">
                    <h3 id="totalPresentes">0</h3>
                    <p>Presentes</p>
                </div>
            </div>
            
            <div class="stat-card card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-info">
                    <h3 id="totalEntradas">0</h3>
                    <p>Entradas Registradas</p>
                </div>
            </div>
            
            <div class="stat-card card">
                <div class="stat-icon">üö™</div>
                <div class="stat-info">
                    <h3 id="totalSaidas">0</h3>
                    <p>Sa√≠das Registradas</p>
                </div>
            </div>
            
            <div class="stat-card card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-info">
                    <h3 id="tempoMedio">0h</h3>
                    <p>Tempo M√©dio</p>
                </div>
            </div>
        </div>

        <!-- Tabela de Presen√ßas -->
        <div class="presencas-container card">
            <div class="presencas-header">
                <h2>üìã Lista de Presen√ßa - <span id="palestraNome">Palestra 1</span></h2>
                <div class="acoes-header">
                    <button class="btn-lista-chamada" onclick="gerarListaChamada()">üìÑ Lista de Chamada</button>
                    <button class="btn-exportar" onclick="exportarCSV()">üì• Exportar CSV</button>
                    <button class="btn-atualizar" onclick="atualizarDados()">üîÑ Atualizar</button>
                </div>
            </div>

            <div class="filtros">
                <input type="text" id="filtroNome" placeholder="üîç Buscar por nome ou RA..." onkeyup="filtrarPresencas()">
                
                <select id="filtroStatus" onchange="filtrarPresencas()">
                    <option value="">Todos os status</option>
                    <option value="presente">‚úÖ Presentes</option>
                    <option value="saiu">üö™ J√° sa√≠ram</option>
                </select>

                <select id="filtroFatec" onchange="filtrarPresencas()">
                    <option value="">Todas as FATECs</option>
                    <option value="FATEC Osasco">FATEC Osasco</option>
                    <option value="FATEC S√£o Paulo">FATEC S√£o Paulo</option>
                    <option value="FATEC Guarulhos">FATEC Guarulhos</option>
                    <option value="FATEC Zona Leste">FATEC Zona Leste</option>
                    <option value="FATEC S√£o Caetano">FATEC S√£o Caetano</option>
                    <option value="FATEC Ipiranga">FATEC Ipiranga</option>
                </select>

                <select id="filtroCurso" onchange="filtrarPresencas()">
                    <option value="">Todos os cursos</option>
                    <option value="ADS">ADS</option>
                    <option value="DSM">DSM</option>
                    <option value="SI">SI</option>
                    <option value="BD">BD</option>
                    <option value="Jogos Digitais">Jogos Digitais</option>
                    <option value="Redes">Redes</option>
                </select>

                <button class="btn-limpar-filtros" onclick="limparFiltros()">üîÑ Limpar Filtros</button>
            </div>

            <!-- Resumo dos Filtros -->
            <div class="resumo-filtros" id="resumoFiltros" style="display: none;">
                <div class="resumo-content">
                    <strong>Filtros ativos:</strong>
                    <span id="resumoTexto"></span>
                </div>
            </div>

            <div class="tabela-wrapper">
                <table class="tabela-presencas">
                    <thead>
                        <tr>
                            <th>RA</th>
                            <th>Nome</th>
                            <th>FATEC</th>
                            <th>Curso</th>
                            <th>Data</th>
                            <th>Hora Entrada</th>
                            <th>Hora Sa√≠da</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaPresencas">
                        <!-- Dados ser√£o inseridos aqui via JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="tabela-footer">
                <p>Total de registros: <strong id="totalRegistros">0</strong></p>
            </div>
        </div>
    </main>

    <script>
        // Buscar dados do usu√°rio logado (docente)
        function preencherHeaderUsuario() {
            fetch('/api/auth/me', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data && data.nome) {
                        document.getElementById('userNome').textContent = data.nome;
                    }
                })
                .catch(() => {
                    document.getElementById('userNome').textContent = 'Docente';
                });
        }
        preencherHeaderUsuario();

        // Carregar palestras e presen√ßas dinamicamente
        let palestraSelecionada = null;
        let todosOsDados = [];

        // Carregar palestras ao iniciar a p√°gina
        window.onload = function() {
            preencherHeaderUsuario();
            carregarPalestras();
        };

        // Carregar presen√ßas (do servidor)
        async function carregarPresencas(palestraId) {
            try {
                const res = await fetch(`/api/presenca/palestra/${palestraId}`);
                const json = await res.json();
                if (json && json.dados) {
                    // Mapear para formato esperado pela UI
                    todosOsDados = json.dados.map(p => {
                        const part = p.participanteId || {};
                        return {
                            ra: part.ra || (part.ra && part.ra.toString()) || '-',
                            nome: part.nome || part.email || '‚Äî',
                            fatec: part.campus || part.fatec || '-',
                            curso: part.curso || '-',
                            data: new Date(p.horario_entrada).toLocaleDateString('pt-BR'),
                            entrada: new Date(p.horario_entrada).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            saida: p.horario_saida ? new Date(p.horario_saida).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
                            status: p.horario_saida ? 'saiu' : 'presente'
                        };
                    });
                } else {
                    todosOsDados = [];
                }

                renderizarTabela(todosOsDados);
                atualizarEstatisticas(todosOsDados);
            } catch (err) {
                console.error('Erro ao carregar presen√ßas:', err);
                todosOsDados = [];
                renderizarTabela(todosOsDados);
                atualizarEstatisticas(todosOsDados);
            }
        }

        // Carregar lista de palestras do servidor
        async function carregarPalestras() {
            try {
                const res = await fetch('/api/palestras');
                const json = await res.json();
                const palestras = (json && json.dados) ? json.dados : [];
                const grid = document.getElementById('palestrasGrid');
                grid.innerHTML = '';

                if (palestras.length === 0) {
                    grid.innerHTML = '<p>Nenhuma palestra encontrada.</p>';
                    return;
                }

                palestras.forEach((p, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'palestra-btn';
                    if (idx === 0) btn.classList.add('active');
                    btn.setAttribute('data-id', p._id);
                    btn.onclick = () => selecionarPalestra(p._id, p.titulo);
                    btn.innerHTML = `
                        <span class="palestra-icon">üé§</span>
                        <span class="palestra-titulo">${p.titulo || 'Sem t√≠tulo'}</span>
                        <span class="palestra-tema">${p.palestrante || ''}</span>
                        <span class="palestra-info">${new Date(p.data).toLocaleString('pt-BR')}</span>
                    `;
                    grid.appendChild(btn);
                });

                // Selecionar a primeira palestra por padr√£o
                selecionarPalestra(palestras[0]._id, palestras[0].titulo);
            } catch (err) {
                console.error('Erro ao carregar palestras:', err);
                document.getElementById('palestrasGrid').innerText = 'Erro ao carregar palestras';
            }
        }

        // Renderizar tabela
        function renderizarTabela(dados) {
            const tbody = document.getElementById('tabelaPresencas');
            tbody.innerHTML = '';
            
            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">Nenhum registro encontrado</td></tr>';
                document.getElementById('totalRegistros').textContent = '0';
                return;
            }
            
            dados.forEach(aluno => {
                const tr = document.createElement('tr');
                const statusClass = aluno.status === 'presente' ? 'status-presente' : 'status-saiu';
                const statusText = aluno.status === 'presente' ? '‚úÖ Presente' : 'üö™ Saiu';
                
                tr.innerHTML = `
                    <td><strong>${aluno.ra}</strong></td>
                    <td>${aluno.nome}</td>
                    <td>${aluno.fatec}</td>
                    <td><span class="badge-curso">${aluno.curso}</span></td>
                    <td>${aluno.data}</td>
                    <td><strong>${aluno.entrada}</strong></td>
                    <td>${aluno.saida || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('totalRegistros').textContent = dados.length;
        }

        // Atualizar estat√≠sticas
        function atualizarEstatisticas(dados) {
            const presentes = dados.filter(a => a.status === 'presente').length;
            const saidas = dados.filter(a => a.status === 'saiu').length;
            const entradas = dados.length;
            
            document.getElementById('totalPresentes').textContent = presentes;
            document.getElementById('totalEntradas').textContent = entradas;
            document.getElementById('totalSaidas').textContent = saidas;
            
            // Calcular tempo m√©dio (simplificado)
            const temposMinutos = dados
                .filter(a => a.saida)
                .map(a => {
                    const [hE, mE] = a.entrada.split(':').map(Number);
                    const [hS, mS] = a.saida.split(':').map(Number);
                    return (hS * 60 + mS) - (hE * 60 + mE);
                });
            
            if (temposMinutos.length > 0) {
                const media = temposMinutos.reduce((a, b) => a + b, 0) / temposMinutos.length;
                const horas = Math.floor(media / 60);
                const minutos = Math.round(media % 60);
                document.getElementById('tempoMedio').textContent = `${horas}h${minutos}m`;
            } else {
                document.getElementById('tempoMedio').textContent = '0h';
            }
        }

        // Filtrar presen√ßas
        function filtrarPresencas() {
            const filtroNome = document.getElementById('filtroNome').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroFatec = document.getElementById('filtroFatec').value;
            const filtroCurso = document.getElementById('filtroCurso').value;
            
            let dadosFiltrados = todosOsDados;
            
            // Filtro por nome ou RA
            if (filtroNome) {
                dadosFiltrados = dadosFiltrados.filter(a => 
                    a.nome.toLowerCase().includes(filtroNome) || 
                    a.ra.includes(filtroNome)
                );
            }
            
            // Filtro por status
            if (filtroStatus) {
                dadosFiltrados = dadosFiltrados.filter(a => a.status === filtroStatus);
            }

            // Filtro por FATEC
            if (filtroFatec) {
                dadosFiltrados = dadosFiltrados.filter(a => a.fatec === filtroFatec);
            }

            // Filtro por Curso
            if (filtroCurso) {
                dadosFiltrados = dadosFiltrados.filter(a => a.curso === filtroCurso);
            }
            
            renderizarTabela(dadosFiltrados);
            atualizarResumoFiltros(filtroNome, filtroStatus, filtroFatec, filtroCurso, dadosFiltrados.length);
        }

        // Atualizar resumo dos filtros
        function atualizarResumoFiltros(nome, status, fatec, curso, total) {
            const resumoDiv = document.getElementById('resumoFiltros');
            const resumoTexto = document.getElementById('resumoTexto');
            
            const filtrosAtivos = [];
            
            if (nome) filtrosAtivos.push(`Busca: "${nome}"`);
            if (status) filtrosAtivos.push(`Status: ${status === 'presente' ? 'Presentes' : 'Sa√≠ram'}`);
            if (fatec) filtrosAtivos.push(`FATEC: ${fatec}`);
            if (curso) filtrosAtivos.push(`Curso: ${curso}`);
            
            if (filtrosAtivos.length > 0) {
                resumoDiv.style.display = 'block';
                resumoTexto.innerHTML = filtrosAtivos.join(' ‚Ä¢ ') + ` <strong>(${total} resultado${total !== 1 ? 's' : ''})</strong>`;
            } else {
                resumoDiv.style.display = 'none';
            }
        }

        // Limpar todos os filtros
        function limparFiltros() {
            document.getElementById('filtroNome').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroFatec').value = '';
            document.getElementById('filtroCurso').value = '';
            filtrarPresencas();
        }

        // Exportar CSV
        function exportarCSV() {
            let csv = 'RA,Nome,FATEC,Curso,Data,Hora Entrada,Hora Sa√≠da,Status\n';
            
            todosOsDados.forEach(aluno => {
                csv += `${aluno.ra},${aluno.nome},${aluno.fatec},${aluno.curso},${aluno.data},${aluno.entrada},${aluno.saida || '-'},${aluno.status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `presencas_palestra_${palestraSelecionada}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Gerar Lista de Chamada (para impress√£o)
        function gerarListaChamada() {
            const filtroFatec = document.getElementById('filtroFatec').value;
            const filtroCurso = document.getElementById('filtroCurso').value;
            
            let dadosListar = todosOsDados;
            
            // Aplicar filtros se existirem
            if (filtroFatec) {
                dadosListar = dadosListar.filter(a => a.fatec === filtroFatec);
            }
            if (filtroCurso) {
                dadosListar = dadosListar.filter(a => a.curso === filtroCurso);
            }

            // Ordenar por nome
            dadosListar.sort((a, b) => a.nome.localeCompare(b.nome));

            // Criar janela de impress√£o
            const janelaImpressao = window.open('', '_blank');
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Lista de Chamada - Palestra ${palestraSelecionada}</title>
                    <style>
                        @page { margin: 2cm; }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 12px;
                        }
                        .cabecalho {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                        }
                        .cabecalho h1 {
                            margin: 0 0 10px 0;
                            font-size: 20px;
                        }
                        .info-palestra {
                            margin: 20px 0;
                            background: #f0f0f0;
                            padding: 15px;
                        }
                        .info-palestra p {
                            margin: 5px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th, td {
                            border: 1px solid #333;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background: #333;
                            color: white;
                            font-weight: bold;
                        }
                        .assinatura {
                            width: 200px;
                        }
                        .rodape {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #ccc;
                            text-align: center;
                            font-size: 10px;
                        }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="cabecalho">
                        <h1>üìã LISTA DE CHAMADA - FATECWEEK 2025</h1>
                        <h2>Palestra ${palestraSelecionada}</h2>
                    </div>

                    <div class="info-palestra">
                        <p><strong>Palestra:</strong> ${document.querySelector('.palestra-btn.active .palestra-tema')?.textContent || 'Palestra ' + palestraSelecionada}</p>
                        <p><strong>Data:</strong> ${todosOsDados[0]?.data || new Date().toLocaleDateString('pt-BR')}</p>
                        <p><strong>Hor√°rio:</strong> ${document.querySelector('.palestra-btn.active .palestra-info')?.textContent || '-'}</p>
                        ${filtroFatec ? `<p><strong>FATEC:</strong> ${filtroFatec}</p>` : ''}
                        ${filtroCurso ? `<p><strong>Curso:</strong> ${filtroCurso}</p>` : ''}
                        <p><strong>Total de Alunos:</strong> ${dadosListar.length}</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 80px;">RA</th>
                                <th>Nome Completo</th>
                                <th style="width: 120px;">FATEC</th>
                                <th style="width: 60px;">Curso</th>
                                <th class="assinatura">Assinatura</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            dadosListar.forEach((aluno, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${aluno.ra}</td>
                        <td>${aluno.nome}</td>
                        <td>${aluno.fatec.replace('FATEC ', '')}</td>
                        <td>${aluno.curso}</td>
                        <td class="assinatura"></td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>

                    <div class="rodape">
                        <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                        <p>FatecWeek 2025 - Sistema de Controle de Presen√ßa</p>
                    </div>

                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 30px; font-size: 16px; cursor: pointer;">
                            üñ®Ô∏è Imprimir
                        </button>
                        <button onclick="window.close()" style="padding: 10px 30px; font-size: 16px; cursor: pointer; margin-left: 10px;">
                            ‚ùå Fechar
                        </button>
                    </div>
                </body>
                </html>
            `;

            janelaImpressao.document.write(html);
            janelaImpressao.document.close();
        }

        // Atualizar dados
        function atualizarDados() {
            carregarPresencas(palestraSelecionada);
            alert('‚úÖ Dados atualizados com sucesso!');
        }

        function logoutUsuario(event) {
            event.preventDefault();
            fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(() => {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            })
            .catch(() => {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            });
        }
    </script>
</body>
</html>