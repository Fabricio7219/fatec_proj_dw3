<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Docente - FatecWeek 2025</title>
    <link rel="stylesheet" href="style-login.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo-link">
                 <img src="https://i.imgur.com/WXNFN93.png" alt="Logo FatecWeek" class="logo-principal">
                    </a>
            <a href="index.html" class="btn-voltar">‚Üê Voltar</a>
        </div>
    </header>

    <main class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>üë®‚Äçüè´ Login Docente</h1>
                <p>Acesse com Microsoft Entra ID (Azure AD)</p>
            </div>

            <div class="login-content">
                <div id="loginStatus" class="status-message"></div>
                
                <!-- Etapa 1: Bot√£o Microsoft -->
                <div id="etapaLogin">
                    <button class="btn-microsoft" onclick="signInEntraID()">
                        <svg width="21" height="21" viewBox="0 0 21 21">
                            <rect width="10" height="10" fill="#F25022"/>
                            <rect x="11" width="10" height="10" fill="#7FBA00"/>
                            <rect y="11" width="10" height="10" fill="#00A4EF"/>
                            <rect x="11" y="11" width="10" height="10" fill="#FFB900"/>
                        </svg>
                        Entrar com Microsoft
                    </button>
                </div>

                <!-- Etapa 2: Formul√°rio -->
                <div id="etapaCadastro" class="form-complemento">
                    <div class="user-card">
                        <h3 id="userName"></h3>
                        <p id="userEmail"></p>
                    </div>

                    <form id="formComplemento" onsubmit="finalizarCadastro(event)">
                        <div class="form-group">
                            <label>Cursos que leciona *</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="cursos" value="ads"> 
                                    <span>ADS</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="cursos" value="dsm"> 
                                    <span>DSM</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="cursos" value="si"> 
                                    <span>Sistemas para Internet</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="cursos" value="bd"> 
                                    <span>Banco de Dados</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="cursos" value="jogos"> 
                                    <span>Jogos Digitais</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="cursos" value="redes"> 
                                    <span>Redes</span>
                                </label>
                            </div>
                            <small>Selecione todos os cursos que voc√™ leciona</small>
                            <div id="errorCursos" class="error-message">
                                ‚ö†Ô∏è Selecione pelo menos um curso
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="fatec">FATEC onde leciona *</label>
                            <select id="fatec" required>
                                <option value="">Selecione</option>
                                <option value="fatec-osasco">FATEC Osasco</option>
                                <option value="fatec-sp">FATEC S√£o Paulo</option>
                                <option value="fatec-zona-leste">FATEC Zona Leste</option>
                                <option value="fatec-zona-sul">FATEC Zona Sul</option>
                                <option value="fatec-guarulhos">FATEC Guarulhos</option>
                            </select>
                        </div>

                        <button type="submit" class="btn-continue">Finalizar e Acessar Sistema</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- MSAL.js para Entra ID -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    
    <script>
        // SUBSTITUA pelo seu Client ID do Azure
        const msalConfig = {
            auth: {
                clientId: "SEU_CLIENT_ID_AQUI",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin + "/login-docente.html"
            },
            cache: {
                cacheLocation: "localStorage"
            }
        };

        const loginRequest = {
            scopes: ["User.Read"]
        };

        const myMSALObj = new msal.PublicClientApplication(msalConfig);
        let dadosUsuario = null;

        // Login Entra ID
        async function signInEntraID() {
            try {
                mostrarMensagem("Redirecionando para Microsoft...", "info");
                const loginResponse = await myMSALObj.loginPopup(loginRequest);
                await handleLoginSuccess(loginResponse);
            } catch (error) {
                console.error(error);
                mostrarMensagem("Erro ao fazer login: " + error.message, "error");
            }
        }

        // Processar login
        async function handleLoginSuccess(response) {
            myMSALObj.setActiveAccount(response.account);
            
            try {
                const tokenResponse = await myMSALObj.acquireTokenSilent({
                    ...loginRequest,
                    account: response.account
                });

                const graphResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
                    headers: { 'Authorization': 'Bearer ' + tokenResponse.accessToken }
                });

                dadosUsuario = await graphResponse.json();
                
                // Verificar permiss√£o
                if (!verificarPermissao(dadosUsuario.mail || dadosUsuario.userPrincipalName, 'docente')) {
                    mostrarMensagem("‚ùå Voc√™ n√£o tem permiss√£o de docente. Contate o administrador.", "error");
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                    return;
                }

                mostrarFormulario();
                
            } catch (error) {
                console.error(error);
                mostrarMensagem("Erro ao obter dados: " + error.message, "error");
            }
        }

        // Verificar permiss√£o no banco de usu√°rios
        function verificarPermissao(email, tipoEsperado) {
            const usuarios = JSON.parse(localStorage.getItem('usuariosAutorizados')) || [];
            const usuario = usuarios.find(u => u.email.toLowerCase() === email.toLowerCase());
            return usuario && usuario.tipo === tipoEsperado;
        }

        function mostrarFormulario() {
            document.getElementById('etapaLogin').style.display = 'none';
            document.getElementById('etapaCadastro').style.display = 'block';
            
            document.getElementById('userName').textContent = dadosUsuario.displayName;
            document.getElementById('userEmail').textContent = dadosUsuario.mail || dadosUsuario.userPrincipalName;
            
            mostrarMensagem("‚úÖ Login realizado! Complete seu cadastro.", "success");
        }

        function finalizarCadastro(event) {
            event.preventDefault();

            // Validar cursos
            const cursosSelecionados = Array.from(document.querySelectorAll('input[name="cursos"]:checked'))
                .map(cb => cb.value);

            if (cursosSelecionados.length === 0) {
                document.getElementById('errorCursos').style.display = 'block';
                return;
            }

            document.getElementById('errorCursos').style.display = 'none';

            const docenteCompleto = {
                nome: dadosUsuario.displayName,
                email: dadosUsuario.mail || dadosUsuario.userPrincipalName,
                cursos: cursosSelecionados,
                fatec: document.getElementById('fatec').value,
                tipo: 'docente',
                dataRegistro: new Date().toISOString()
            };

            localStorage.setItem('usuarioLogado', JSON.stringify(docenteCompleto));
            
            mostrarMensagem("‚úÖ Cadastro completo! Redirecionando...", "success");
            
            setTimeout(() => {
                window.location.href = 'dashboard-docente.html';
            }, 1500);
        }

        function mostrarMensagem(texto, tipo) {
            const msg = document.getElementById('loginStatus');
            msg.textContent = texto;
            msg.className = `status-message ${tipo}`;
            msg.style.display = 'block';
            
            if (tipo === 'success') {
                setTimeout(() => {
                    msg.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>