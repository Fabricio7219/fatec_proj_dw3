<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Aluno - FatecWeek 2025</title>
    <link rel="stylesheet" href="style-login.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo-link">
                 <img src="https://i.imgur.com/WXNFN93.png" alt="Logo FatecWeek" class="logo-principal">
                    </a>
            <a href="index.html" class="btn-voltar">‚Üê Voltar</a>
        </div>
    </header>

    <main class="login-container">
        <div class="login-card">
            <div class="login-header aluno">
                <h1>üéì Login Aluno</h1>
                <p>Acesse com Microsoft Entra ID (Azure AD)</p>
            </div>

            <div class="login-content">
                <div id="loginStatus" class="status-message"></div>
                
                <!-- Etapa 1: Bot√£o Microsoft -->
                <div id="etapaLogin">
                    <button class="btn-microsoft" onclick="signInEntraID()">
                        <svg width="21" height="21" viewBox="0 0 21 21">
                            <rect width="10" height="10" fill="#F25022"/>
                            <rect x="11" width="10" height="10" fill="#7FBA00"/>
                            <rect y="11" width="10" height="10" fill="#00A4EF"/>
                            <rect x="11" y="11" width="10" height="10" fill="#FFB900"/>
                        </svg>
                        Entrar com Microsoft
                    </button>
                </div>

                <!-- Etapa 2: Formul√°rio -->
                <div id="etapaCadastro" class="form-complemento">
                    <div class="user-card">
                        <h3 id="userName"></h3>
                        <p id="userEmail"></p>
                    </div>

                    <form id="formComplemento" onsubmit="finalizarCadastro(event)">
                        <div class="form-group">
                            <label for="ra">RA (Registro Acad√™mico) *</label>
                            <input type="text" id="ra" required 
                                   placeholder="Digite seu RA"
                                   pattern="[0-9]+" 
                                   maxlength="10"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            <small>Apenas n√∫meros. Exemplo: 123456</small>
                        </div>

                        <div class="form-group">
                            <label for="fatec">Sua FATEC *</label>
                            <select id="fatec" required>
                                <option value="">Selecione sua FATEC</option>
                                <option value="fatec-osasco">FATEC Osasco</option>
                                <option value="fatec-sp">FATEC S√£o Paulo</option>
                                <option value="fatec-zona-leste">FATEC Zona Leste</option>
                                <option value="fatec-zona-sul">FATEC Zona Sul</option>
                                <option value="fatec-guarulhos">FATEC Guarulhos</option>
                                <option value="outra">Outra FATEC</option>
                            </select>
                        </div>

                        <div class="form-group" id="outraFatecGroup" style="display: none;">
                            <label for="outraFatec">Qual FATEC?</label>
                            <input type="text" id="outraFatec" placeholder="Digite o nome">
                        </div>

                        <button type="submit" class="btn-continue aluno">Finalizar e Acessar Sistema</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- MSAL.js para Entra ID -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    
    <script>
        // SUBSTITUA pelo seu Client ID do Azure
        const msalConfig = {
            auth: {
                clientId: "SEU_CLIENT_ID_AQUI",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin + "/login-aluno.html"
            },
            cache: {
                cacheLocation: "localStorage"
            }
        };

        const loginRequest = {
            scopes: ["User.Read"]
        };

        const myMSALObj = new msal.PublicClientApplication(msalConfig);
        let dadosUsuario = null;

        // Login Entra ID
        async function signInEntraID() {
            try {
                mostrarMensagem("Redirecionando para Microsoft...", "info");
                const loginResponse = await myMSALObj.loginPopup(loginRequest);
                await handleLoginSuccess(loginResponse);
            } catch (error) {
                console.error(error);
                mostrarMensagem("Erro ao fazer login: " + error.message, "error");
            }
        }

        // Processar login
        async function handleLoginSuccess(response) {
            myMSALObj.setActiveAccount(response.account);
            
            try {
                const tokenResponse = await myMSALObj.acquireTokenSilent({
                    ...loginRequest,
                    account: response.account
                });

                const graphResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
                    headers: { 'Authorization': 'Bearer ' + tokenResponse.accessToken }
                });

                dadosUsuario = await graphResponse.json();
                
                // Verificar permiss√£o
                if (!verificarPermissao(dadosUsuario.mail || dadosUsuario.userPrincipalName, 'aluno')) {
                    mostrarMensagem("‚ùå Voc√™ n√£o tem permiss√£o de aluno. Contate o administrador.", "error");
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                    return;
                }

                mostrarFormulario();
                
            } catch (error) {
                console.error(error);
                mostrarMensagem("Erro ao obter dados: " + error.message, "error");
            }
        }

        // Verificar permiss√£o no banco de usu√°rios
        function verificarPermissao(email, tipoEsperado) {
            const usuarios = JSON.parse(localStorage.getItem('usuariosAutorizados')) || [];
            const usuario = usuarios.find(u => u.email.toLowerCase() === email.toLowerCase());
            return usuario && usuario.tipo === tipoEsperado;
        }

        function mostrarFormulario() {
            document.getElementById('etapaLogin').style.display = 'none';
            document.getElementById('etapaCadastro').style.display = 'block';
            
            document.getElementById('userName').textContent = dadosUsuario.displayName;
            document.getElementById('userEmail').textContent = dadosUsuario.mail || dadosUsuario.userPrincipalName;
            
            mostrarMensagem("‚úÖ Login realizado! Complete seu cadastro.", "success");
        }

        // Campo "Outra FATEC"
        document.addEventListener('DOMContentLoaded', function() {
            const selectFatec = document.getElementById('fatec');
            if (selectFatec) {
                selectFatec.addEventListener('change', function() {
                    const outraGroup = document.getElementById('outraFatecGroup');
                    const outraInput = document.getElementById('outraFatec');
                    
                    if (this.value === 'outra') {
                        outraGroup.style.display = 'block';
                        outraInput.required = true;
                    } else {
                        outraGroup.style.display = 'none';
                        outraInput.required = false;
                    }
                });
            }
        });

        function finalizarCadastro(event) {
            event.preventDefault();

            const alunoCompleto = {
                nome: dadosUsuario.displayName,
                email: dadosUsuario.mail || dadosUsuario.userPrincipalName,
                ra: document.getElementById('ra').value,
                fatec: document.getElementById('fatec').value,
                outraFatec: document.getElementById('outraFatec').value,
                tipo: 'aluno',
                dataRegistro: new Date().toISOString()
            };

            localStorage.setItem('usuarioLogado', JSON.stringify(alunoCompleto));
            
            mostrarMensagem("‚úÖ Cadastro completo! Redirecionando...", "success");
            
            setTimeout(() => {
                window.location.href = 'dashboard-aluno.html';
            }, 1500);
        }

        function mostrarMensagem(texto, tipo) {
            const msg = document.getElementById('loginStatus');
            msg.textContent = texto;
            msg.className = `status-message ${tipo}`;
            msg.style.display = 'block';
            
            if (tipo === 'success') {
                setTimeout(() => {
                    msg.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>